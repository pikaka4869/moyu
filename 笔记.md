# EasyMocap

### 部署测试
传送门[](https://sundaybox.cc/pages/7fef79/)

---

### 更换yolo模型
只需传入模型路径参数<br>
由于代码中使用了 YOLOv5 的 API ，后来的yolo模型（如yolov8）并不适用，还需更改detect()函数的输出格式<br>
后续发现问题：在可视化阶段，检测到边界框数组为空，但代码并未特判，直接访问，导致数组越界报错。加入特判数组是否为空部分即可<br>
***yolo github仓库[](https://github.com/ultralytics/assets/releases/tag/v8.3.0)***

---

### 尝试将输入更换成视频流，实现实时渲染

- 测试用视频流
    - 媒体流服务器选择Mediamtx（rtsp-simple-server）
    - 启动Mediamtx服务器
        ```bash
        # 切换到mediamtx.exe所在目录
        mediamtx.exe
        ```
    - 推送视频流
        ```bash
        ffmpeg -stream_loop -1 -i ../test/01.mp4 -c copy -f rtsp -rtsp_transport tcp rtsp://localhost:8554/mystream
        ```
    - 测试播放
        ```bash
        ffplay -rtsp_transport tcp rtsp://localhost:8554/mystream
        ```
- 从视频流中获取帧信息
    - 配置文件（在原来的基础上新增流式数据源及相机参数）
    - 创建流式数据集类，返回格式为模型可接受形式
    - 
        ```bash
        emc --data config/datasets/stream.yml --exp config/mv1p/detect_triangulate_fitSMPL.yml --root .\data\test\  --subs_vis 01 02 03 04
        ```
- 尝试优化
    - 跳过vis2d及visualize步骤——每秒稳定在处理5组，每组4个图片，速率提高了40%
    - 删除缓存步骤——效果不明显
    - 尝试使用多线程——有提升，但很小
    - TODO: 尝试使用批处理
  
---

### 将 HRNet 替换为 RTMPose

torch版本2.5.1有问题，需要替换为2.1.2

```python
# 1. 先卸载当前的torch版本
pip uninstall torch torchvision torchaudio -y

# 2. 安装torch
pip install torch==2.1.2 torchvision==0.16.2 torchaudio==2.1.2 --index-url https://download.pytorch.org/whl/cu121
pip install numpy==1.26.4

# 3. 安装openmim
pip install openmim

# 4. 使用mim安装其他包
mim install mmengine
mim install "mmcv==2.1.0"
mim install mmdet
mim install mmpose
```

#### 可能遇到的问题及解决方案

- **问题**：  
  `FileNotFoundError: [Errno 2] No such file or directory: 'X:\\XXX\\../../../_base_/default_runtime.py'`

- **解决方案**：  
  将 `rtmpose-m_8xb256-420e_coco-256x192.py` 文件中的 `_base_` 路径修改为  
  `['{你的conda环境}/Lib/site-packages/mmpose/.mim/configs/_base_/default_runtime.py']`  
  （请将 `{你的conda环境}` 替换为实际路径）。

- **问题**：  
  `无法编译pymatchlr`

- **解决方案**：  
  尝试使用cmake版本3.22.1，成功编译pymatchlr